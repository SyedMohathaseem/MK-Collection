<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | MK Collection</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/pages.css">
</head>
<body>
    <header class="header" style="border-bottom:1px solid var(--color-gray-200)">
        <div class="header-inner">
            <a href="index.html" class="logo">MK<span>Collection</span></a>
            <div style="display:flex;align-items:center;gap:var(--space-2);font-size:var(--text-sm);color:var(--color-gray-500)">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                Secure Checkout
            </div>
        </div>
    </header>

    <main class="main">
        <div class="checkout-page">
            <div class="container">
                <div class="checkout-grid">
                    <!-- Checkout Form -->
                    <div class="checkout-form">
                        <!-- Contact -->
                        <div class="checkout-section">
                            <h3>Contact Information</h3>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="checkout-email" placeholder="your@email.com" required>
                            </div>
                            <label class="filter-option" style="font-size:var(--text-sm)">
                                <input type="checkbox" checked> Email me with news and offers
                            </label>
                        </div>

                        <!-- Shipping -->
                        <div class="checkout-section">
                            <h3>Shipping Address</h3>
                            <div class="checkout-row">
                                <div class="form-group">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-input" id="first-name" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-input" id="last-name" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Address</label>
                                <input type="text" class="form-input" id="address1" placeholder="Street address" required>
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-input" id="address2" placeholder="Apartment, suite, etc. (optional)">
                            </div>
                            <div class="checkout-row">
                                <div class="form-group">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-input" id="city" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">State</label>
                                    <select class="form-input form-select" id="state" required>
                                        <option value="">Select state</option>
                                        <option value="NY">New York</option>
                                        <option value="CA">California</option>
                                        <option value="TX">Texas</option>
                                        <option value="FL">Florida</option>
                                    </select>
                                </div>
                            </div>
                            <div class="checkout-row">
                                <div class="form-group">
                                    <label class="form-label">ZIP Code</label>
                                    <input type="text" class="form-input" id="zip" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-input" id="phone" placeholder="For delivery updates">
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Method -->
                        <div class="checkout-section">
                            <h3>Shipping Method</h3>
                            <div style="border:1px solid var(--color-gray-200);border-radius:var(--radius-lg);overflow:hidden">
                                <label style="display:flex;align-items:center;justify-content:space-between;padding:var(--space-4);background:var(--color-blush-light);border-bottom:1px solid var(--color-gray-200);cursor:pointer">
                                    <div style="display:flex;align-items:center;gap:var(--space-3)">
                                        <input type="radio" name="shipping" value="standard" checked>
                                        <div>
                                            <strong>Standard Shipping</strong>
                                            <p style="font-size:var(--text-sm);color:var(--color-gray-500);margin:0">5-7 business days</p>
                                        </div>
                                    </div>
                                    <span id="standard-shipping-price">$9.99</span>
                                </label>
                                <label style="display:flex;align-items:center;justify-content:space-between;padding:var(--space-4);cursor:pointer">
                                    <div style="display:flex;align-items:center;gap:var(--space-3)">
                                        <input type="radio" name="shipping" value="express">
                                        <div>
                                            <strong>Express Shipping</strong>
                                            <p style="font-size:var(--text-sm);color:var(--color-gray-500);margin:0">2-3 business days</p>
                                        </div>
                                    </div>
                                    <span>$19.99</span>
                                </label>
                            </div>
                        </div>

                        <!-- Payment -->
                        <div class="checkout-section">
                            <h3>Payment</h3>
                            <p style="font-size:var(--text-sm);color:var(--color-gray-500);margin-bottom:var(--space-4)">All transactions are secure and encrypted.</p>
                            <div style="border:1px solid var(--color-gray-200);border-radius:var(--radius-lg);padding:var(--space-6)">
                                <div class="form-group">
                                    <label class="form-label">Card Number</label>
                                    <input type="text" class="form-input" placeholder="1234 5678 9012 3456" maxlength="19">
                                </div>
                                <div class="checkout-row">
                                    <div class="form-group">
                                        <label class="form-label">Expiration</label>
                                        <input type="text" class="form-input" placeholder="MM / YY">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Security Code</label>
                                        <input type="text" class="form-input" placeholder="CVV" maxlength="4">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Name on Card</label>
                                    <input type="text" class="form-input">
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-primary btn-full btn-lg" onclick="placeOrder()">Place Order</button>
                        <p style="text-align:center;font-size:var(--text-sm);color:var(--color-gray-500);margin-top:var(--space-4)">
                            By placing your order, you agree to our Terms of Service and Privacy Policy.
                        </p>
                    </div>

                    <!-- Order Summary -->
                    <div class="order-summary">
                        <div class="order-summary-header">
                            <h2>Order Summary</h2>
                        </div>
                        <div class="order-summary-items" id="order-items"></div>
                        <div class="order-summary-footer">
                            <div class="cart-summary-row"><span>Subtotal</span><span id="order-subtotal">$0.00</span></div>
                            <div class="cart-summary-row"><span>Shipping</span><span id="order-shipping">$9.99</span></div>
                            <div class="cart-summary-row"><span>Tax</span><span id="order-tax">$0.00</span></div>
                            <div class="cart-summary-row total"><span>Total</span><span id="order-total">$0.00</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer" style="padding:var(--space-6) 0">
        <div class="container">
            <div class="footer-bottom" style="border:none;padding:0">
                <p class="footer-copyright">Â© MK Collection. All rights reserved.</p>
                <div class="footer-links"><a href="#">Privacy</a><a href="#">Terms</a></div>
            </div>
        </div>
    </footer>

    <div class="toast-container"></div>

    <script src="js/data.js"></script>
    <script src="js/store.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/wishlist.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const items = MKCart.getItems();
            if (items.length === 0) {
                window.location.href = 'cart.html';
                return;
            }
            renderOrderSummary();

            // Pre-fill only for website customers (not admin users)
            if (MKAuth.isWebsiteUser()) {
                const user = MKAuth.getUser();
                document.getElementById('checkout-email').value = user.email;
                document.getElementById('first-name').value = user.firstName || '';
                document.getElementById('last-name').value = user.lastName || '';
            }

            // Update shipping price display
            const subtotal = MKCart.getSubtotal();
            if (subtotal >= 150) {
                document.getElementById('standard-shipping-price').textContent = 'FREE';
            }
        });

        function renderOrderSummary() {
            const items = MKCart.getItems();
            const container = document.getElementById('order-items');

            container.innerHTML = items.map(item => `
                <div class="order-summary-item">
                    <div class="order-summary-item-image">
                        <img src="${item.image}" alt="${item.name}">
                        <span class="order-summary-item-qty">${item.quantity}</span>
                    </div>
                    <div style="flex:1">
                        <p style="font-weight:var(--font-medium);margin:0 0 var(--space-1)">${item.name}</p>
                        <p style="font-size:var(--text-sm);color:var(--color-gray-500);margin:0">${item.color || ''} ${item.size ? '/ ' + item.size : ''}</p>
                    </div>
                    <span style="font-weight:var(--font-medium)">$${(item.price * item.quantity).toFixed(2)}</span>
                </div>
            `).join('');

            updateTotals();
        }

        function updateTotals() {
            const subtotal = MKCart.getSubtotal();
            const shipping = MKCart.getShipping();
            const tax = MKCart.getTax();
            const total = subtotal + shipping + tax;

            document.getElementById('order-subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('order-shipping').textContent = shipping === 0 ? 'FREE' : `$${shipping.toFixed(2)}`;
            document.getElementById('order-tax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('order-total').textContent = `$${total.toFixed(2)}`;
        }

        async function placeOrder() {
            // Production Validation: Regex for better reliability
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const phoneRegex = /^\+?[\d\s-]{10,}$/;
            const zipRegex = /^\d{5}(-\d{4})?$/;

            const email = document.getElementById('checkout-email').value;
            const firstName = document.getElementById('first-name').value;
            const lastName = document.getElementById('last-name').value;
            const phone = document.getElementById('phone').value;
            const address1 = document.getElementById('address1').value;
            const city = document.getElementById('city').value;
            const state = document.getElementById('state').value;
            const zip = document.getElementById('zip').value;

            if (!email || !firstName || !lastName || !address1 || !city || !state || !zip) {
                MKApp.showToast('Please fill in all required fields', 'error');
                return;
            }

            if (!emailRegex.test(email)) {
                MKApp.showToast('Please enter a valid email address', 'error');
                return;
            }

            if (phone && !phoneRegex.test(phone)) {
                MKApp.showToast('Please enter a valid phone number', 'error');
                return;
            }

            if (!zipRegex.test(zip)) {
                MKApp.showToast('Please enter a valid ZIP code (5 digits)', 'error');
                return;
            }

            const btn = document.querySelector('button[onclick="placeOrder()"]');
            MKUI.setLoading(btn, true);

            // Production Guard: Pre-Order Stock Verification
            const cartItems = MKCart.getItems();
            if (typeof MKStore !== 'undefined') {
                const stockCheck = MKStore.checkStockAvailability(cartItems.map(item => ({
                    productId: item.productId,
                    name: item.name,
                    size: item.size,
                    quantity: item.quantity
                })));

                if (!stockCheck.available) {
                    MKApp.showToast(stockCheck.error, 'error');
                    MKUI.setLoading(btn, false);
                    return;
                }
            }

            // Simulate order placement
            MKApp.showToast('Processing your order...', 'default');

            await new Promise(r => setTimeout(r, 2000));

            // Create order in shared store (syncs to admin)
            const subtotal = MKCart.getSubtotal();
            const shipping = MKCart.getShipping();
            const tax = MKCart.getTax();
            const total = subtotal + shipping + tax;

            const orderData = {
                customer: `${firstName} ${lastName}`,
                email: email,
                phone: phone || '',
                address: `${address1}, ${city}, ${state} ${zip}`,
                items: cartItems.length,
                itemDetails: cartItems.map(item => ({
                    productId: item.productId,
                    name: item.name,
                    size: item.size,
                    color: item.color,
                    quantity: item.quantity,
                    price: item.price
                })),
                subtotal: subtotal,
                shipping: shipping,
                tax: tax,
                total: total
            };

            // Save order to MKStore (syncs with admin)
            let orderId = 'MK' + Date.now().toString().slice(-8);
            try {
                if (typeof MKStore !== 'undefined') {
                    const order = MKStore.addOrder(orderData);
                    orderId = order.id;
                }

                MKCart.clear();
                MKApp.updateCartBadge();
                
                // Show success
                document.querySelector('.checkout-grid').innerHTML = `
                    <div style="text-align:center;padding:var(--space-16);grid-column:1/-1">
                        <div style="width:80px;height:80px;margin:0 auto var(--space-6);background:var(--color-success);border-radius:var(--radius-full);display:flex;align-items:center;justify-content:center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="white" width="40" height="40"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        </div>
                        <h2>Thank You for Your Order!</h2>
                        <p style="color:var(--color-gray-600);margin:var(--space-4) 0 var(--space-8)">Order #${orderId} has been placed successfully.<br>You will receive a confirmation email shortly.</p>
                        <a href="index.html" class="btn btn-primary btn-lg">Continue Shopping</a>
                    </div>
                `;
            } catch (e) {
                MKApp.showToast(e.message, 'error');
            } finally {
                MKUI.setLoading(btn, false);
            }
        }
    </script>
</body>
</html>
